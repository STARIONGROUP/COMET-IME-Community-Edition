// --------------------------------------------------------------------------------------------------------------------
// <copyright file="NestedElementExcelRow.cs" company="Starion Group S.A.">
//   Copyright (c) 2015 Starion Group S.A.
// </copyright>
// --------------------------------------------------------------------------------------------------------------------

namespace CDP4ParameterSheetGenerator.OptionSheet
{
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using CDP4Common.EngineeringModelData;
    using CDP4Common.SiteDirectoryData;
    using CDP4ParameterSheetGenerator.RowModels;

    /// <summary>
    /// The purpose of the <see cref="NestedElementExcelRow"/> is to represent <see cref="NestedElement"/>s in the 
    /// <see cref="Option"/> Sheet
    /// </summary>
    public class NestedElementExcelRow : ExcelRowBase<NestedElement>
    {
        /// <summary>
        /// Initializes a new instance of the <see cref="NestedElementExcelRow"/> class.
        /// </summary>
        /// <param name="nestedElement">
        /// The <see cref="NestedElement"/> that is represented by the current row view-model
        /// </param>
        /// <param name="owner">
        /// The <see cref="DomainOfExpertise"/> that is the owner of any <see cref="NestedParameter"/>
        /// in the <see cref="NestedElement"/> that is represented by the current row.
        /// </param>
        public NestedElementExcelRow(NestedElement nestedElement, DomainOfExpertise owner)
            : base(nestedElement)
        {
            this.UpdateProperties();

            var nestedParameters = nestedElement.NestedParameter.ToList();
            this.ProcessNestedParameters(nestedParameters, owner);
        }

        /// <summary>
        /// Update the properties of the <see cref="ExcelRowBase{T}"/>
        /// </summary>
        private void UpdateProperties()
        {
            this.Id = this.Thing.Iid.ToString();
            this.Level = this.Thing.ElementUsage.Count;

            var spaces = new string(' ', 3 * Math.Abs(this.Level));
            this.Name = $"{spaces}{this.Thing.Name}";

            this.ShortName = this.Thing.ShortName;
            this.Type = OptionSheetConstants.NE;
            this.Owner = this.Thing.Owner.ShortName;

            var optionShortName = "-";
            var containerOption = this.Thing.Container as Option;
            if (containerOption != null)
            {
                optionShortName = containerOption.ShortName;
            }

            this.ModelCode = $"{this.Thing.ShortName}\\{optionShortName}";

            if (this.Thing.IsRootElement)
            {
                this.Categories = this.Thing.RootElement.GetAllCategoryShortNames();
            }

            var elementUsage = this.Thing.ElementUsage.LastOrDefault();
            if (elementUsage != null)
            {
                this.Categories = elementUsage.GetAllCategoryShortNames();
            }
        }

        /// <summary>
        /// Process the <see cref="NestedParameter"/>s that are contained by the <see cref="NestedElement"/> that is represented by the current excel row        
        /// </summary>
        /// <param name="nestedParameters">The <see cref="NestedParameter"/>s contained by the <see cref="NestedElement"/>.</param>
        /// <param name="owner">
        /// The <see cref="DomainOfExpertise"/> that is the owner of any <see cref="NestedParameter"/> or <see cref="NestedElement"/>
        /// in the <see cref="NestedElement"/> that is represented by the current row.
        /// </param>        
        private void ProcessNestedParameters(IEnumerable<NestedParameter> nestedParameters, DomainOfExpertise owner)
        {
            var orderedParameters = nestedParameters.OrderBy(np => np.Path);

            foreach (var nestedParameter in orderedParameters)
            {
                if (nestedParameter.Owner == owner)
                {
                    if (nestedParameter.ActualState != null && nestedParameter.ActualState.Kind == ActualFiniteStateKind.FORBIDDEN)
                    {
                        continue;
                    }

                    var nestedParameterExcelRow = new NestedParameterExcelRow(nestedParameter, this.Level);
                    this.ContainedRows.Add(nestedParameterExcelRow);
                }
            }
        }
    }
}